syntax = "proto3";

package agent.v1;

option go_package = "github.com/clustercost/backend/proto/agent/v1;agentv1";

service Collector {
  // Report sends a batch of metrics from the agent to the aggregator.
  rpc Report(ReportRequest) returns (ReportResponse);
}

message ReportRequest {
  string agent_id = 1;
  string cluster_id = 2;
  string node_name = 3;
  string availability_zone = 4;
  int64 timestamp_seconds = 5;

  repeated PodMetric pods = 6;
}

message ReportResponse {
  bool accepted = 1;
  string error_message = 2;
}

message PodMetric {
  // Metadata Context
  string pod_uid = 1;
  string container_id = 2;
  uint32 pid_tgid = 3;
  
  string namespace = 4;
  string pod_name = 5;

  // Compute Performance
  CpuMetrics cpu = 6;
  MemoryMetrics memory = 7;

  // Cost-Aware Network
  NetworkMetrics network = 8;

  // Storage I/O
  StorageMetrics storage = 9;
}

message CpuMetrics {
  // Total nanoseconds in user space
  uint64 usage_user_ns = 1;
  // Total nanoseconds in kernel space
  uint64 usage_kernel_ns = 2;
  // Total run_delay (throttling) in nanoseconds
  uint64 throttling_ns = 3;
}

message MemoryMetrics {
  // Resident Set Size (bytes)
  uint64 rss_bytes = 1;
  // Major page faults
  uint64 page_faults_major = 2;
}

message NetworkMetrics {
  // Throughput
  uint64 bytes_sent = 1;
  uint64 bytes_received = 2;

  // Traffic Categorization (Egress Analyzer)
  uint64 egress_public_bytes = 3;
  uint64 egress_cross_az_bytes = 4;
  uint64 egress_internal_bytes = 5;
}

message StorageMetrics {
  // Throughput
  uint64 read_bytes = 1;
  uint64 write_bytes = 2;
  
  // IOPS
  uint64 read_ops = 3;
  uint64 write_ops = 4;

  // Latency
  uint64 total_latency_ns = 5; 
}
